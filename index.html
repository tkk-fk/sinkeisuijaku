<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ç¥çµŒè¡°å¼±ï¼ˆã²ã‚‰ãŒãªãƒšã‚¢ï¼‰</title>
  <style>
    :root{
      /* 4åˆ—Ã—4è¡ŒãŒå¸¸ã«ç”»é¢å†…ã«åã¾ã‚‹ã‚ˆã†è‡ªå‹•èª¿æ•´ï¼ˆæœ€å¤§90pxï¼‰ */
      --gap: clamp(8px, 2.5vw, 16px);
      --card-w: min(90px, calc((96vw - 3*var(--gap)) / 4));
      --card-h: calc(var(--card-w) * 1.33);
      --accent: #4f46e5;
      --back: #0ea5e9;
      --front: #ffffff;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, "BIZ UDPGothic", "Noto Sans JP", sans-serif;
      background: #f5f7fb; color:#111827; display:flex; flex-direction:column; align-items:center; min-height:100vh;
    }
    header{ width: min(960px, 96vw); padding:16px 12px; }
    h1{ margin: 8px 0 4px; font-size: clamp(20px, 3.6vw, 28px); }
    .sub{ color:#6b7280; margin:0 0 8px; }

    .hud{
      width: min(960px, 96vw);
      display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:8px;
      background:#fff; border-radius:16px; padding:12px 14px; box-shadow: 0 6px 20px rgba(0,0,0,.05);
    }
    .score{ display:flex; gap:10px; align-items:center; justify-content:flex-start; font-weight:700; }
    .score .you{ color:#065f46 }
    .score .pc{ color:#7c2d12 }
    .turn{ text-align:center; font-weight:700; }
    .turn .badge{ display:inline-block; padding:4px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .actions{ width:min(960px,96vw); display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap; }
    button{ cursor:pointer; border:none; border-radius:999px; padding:10px 14px; font-weight:700; background: var(--accent); color:white; }
    button.secondary{ background:#e5e7eb; color:#111827; }

    main{ width:min(960px, 96vw); margin:14px auto; display:flex; justify-content:center; }
    /* ç”»é¢å¹…ãŒç‹­ã„ç«¯æœ«ã§ã‚‚æŠ˜ã‚Šè¿”ã—ã¦åã‚ã‚‹ */
    .grid{ display:grid; grid-template-columns: repeat(4, var(--card-w)); grid-template-rows: repeat(4, var(--card-h)); gap: var(--gap); justify-content:center; }

    .card{ width:var(--card-w); height:var(--card-h); perspective: 900px; }
    .inner{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition: transform .4s ease; }
    .card.flipped .inner, .card.matched .inner{ transform: rotateY(180deg); }

    .face{ position:absolute; inset:0; border-radius:14px; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; box-shadow: 0 8px 18px rgba(0,0,0,.08); padding:6px; }
    .front{ background: var(--front); transform: rotateY(180deg); border: 2px solid #e5e7eb; }
    .front .txt{ font-size: clamp(14px, 5vw, 24px); font-weight:900; letter-spacing: .03em; color:#000; text-align:center; word-break: keep-all; line-height:1.1; writing-mode: vertical-rl; text-orientation: upright; }

    .back{ background: linear-gradient(135deg, var(--back), #22c55e);
           color:white; font-weight:900; border: 2px solid rgba(255,255,255,.35); }
    .back .dot{ width:60%; height:60%; border: 3px dashed rgba(255,255,255,.7); border-radius:12px; display:flex; align-items:center; justify-content:center; }
    .back .mini{ font-size: clamp(12px, 3.6vw, 16px); opacity:.9 }

    .status{ width:min(960px, 96vw); margin:6px auto 2px; text-align:center; color:#374151; min-height:1.6em; }

    .footer{ margin: 10px 0 24px; color:#6b7280; font-size:13px; }

    /* === Words Editor === */
    .words-editor{ width:min(960px,96vw); margin:8px auto 0; background:#fff; border-radius:16px; box-shadow: 0 6px 20px rgba(0,0,0,.05); padding:12px; }
    .words-editor summary{ cursor:pointer; font-weight:700; }
    .words-editor .row{ display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .words-editor textarea{ flex:1 1 520px; min-height:70px; font-size:15px; padding:10px; border:1px solid #e5e7eb; border-radius:10px; resize:vertical; }
    .hint{ color:#6b7280; font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; margin-left:4px; }
  </style>
</head>
<body>
  <header>
    <h1>ç¥çµŒè¡°å¼±ï¼ˆã²ã‚‰ãŒãªãƒšã‚¢ï¼‰</h1>
    <p class="sub">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ vs PCï½œåŒã˜ã²ã‚‰ãŒãªã®ãƒšã‚¢ã‚’è¦‹ã¤ã‘ã‚ˆã†ï¼</p>
  </header>

  <div class="hud" role="region" aria-label="ã‚¹ã‚³ã‚¢">
    <div class="score" id="scoreYou">ğŸ‘¤ ã‚ãªãŸï¼š<span class="you" id="youPts">0</span></div>
    <div class="turn"><span class="badge" id="turnBadge">ã‚ãªãŸã®ç•ª</span></div>
    <div class="score" id="scorePc" style="justify-content:flex-end">ğŸ¤– PCï¼š<span class="pc" id="pcPts">0</span></div>
  </div>

  <details class="words-editor">
    <summary>ã“ã¨ã°ã‚’ç·¨é›† <span class="pill" id="wordCountPill">8èª</span></summary>
    <div class="row">
      <textarea id="wordsInput" placeholder="ä¾‹ï¼šã†ã‚“ã“, ã‚ã‚“ã“, ã­ã“, ã„ã¬, ã•ã‚‹, ã±ã‚“ã , ãã†, ã”ã‚Šã‚‰"></textarea>
    </div>
    <div class="row">
      <button id="btnApplyWords">ã“ã¨ã°ã‚’é©ç”¨</button>
      <button id="btnResetWords" class="secondary">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
      <span class="hint">â€» 8èªã¡ã‚‡ã†ã©ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå„2æšã§16æšã«ãªã‚Šã¾ã™ï¼‰ã€‚æ”¹è¡Œã‚„ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã©ã¡ã‚‰ã§ã‚‚OKã€‚</span>
    </div>
  </details>

  <main>
    <div class="grid" id="board" aria-live="polite" aria-label="ã‚«ãƒ¼ãƒ‰ãƒœãƒ¼ãƒ‰"></div>
  </main>

  <div class="status" id="status"></div>
  <div class="actions">
    <button id="btnRestart" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnNew">ã‚·ãƒ£ãƒƒãƒ•ãƒ« & æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
  </div>

  <div class="footer">Â© ç‰¹åˆ¥æ”¯æ´æ•™æé–‹ç™ºç ”ç©¶æ‰€</div>

<script>
(() => {
  // ====== è¨­å®šï¼ˆã“ã¨ã°ç·¨é›†å¯¾å¿œï¼‰ ======
  const DEFAULT_WORDS = [
    "ã†ã‚“ã“", "ã‚ã‚“ã“", "ã­ã“", "ã„ã¬", "ã•ã‚‹", "ã±ã‚“ã ", "ãã†", "ã”ã‚Šã‚‰"
  ];
  let WORDS = loadWords(); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰

  // è¦ç´ å‚ç…§
  const boardEl = document.getElementById('board');
  const youPtsEl = document.getElementById('youPts');
  const pcPtsEl = document.getElementById('pcPts');
  const turnBadge = document.getElementById('turnBadge');
  const statusEl = document.getElementById('status');
  const btnRestart = document.getElementById('btnRestart');
  const btnNew = document.getElementById('btnNew');
  const wordsInput = document.getElementById('wordsInput');
  const btnApplyWords = document.getElementById('btnApplyWords');
  const btnResetWords = document.getElementById('btnResetWords');
  const wordCountPill = document.getElementById('wordCountPill');

  // åˆæœŸè¡¨ç¤ºã«ç¾åœ¨ã®WORDSã‚’åæ˜ 
  wordsInput.value = WORDS.join(', ');
  updateWordCountPill();

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  let deck = []; // {id, word, matched}
  let firstPick = null;
  let secondPick = null;
  let lockInput = false; // ã‚¢ãƒ‹ãƒ¡ä¸­/PCã®æ‰‹ç•ªãªã©ã§å…¥åŠ›ã‚’ãƒ­ãƒƒã‚¯
  let playerTurn = true; // true=ã‚ãªãŸ, false=PC
  let youScore = 0, pcScore = 0;

  function shuffle(array){
    for(let i=array.length-1; i>0; i--){
      const j = Math.floor(Math.random() * (i+1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function buildDeck(){
    const pairs = WORDS.flatMap((w, idx) => [
      { id: `${idx}-a`, word: w, matched:false },
      { id: `${idx}-b`, word: w, matched:false }
    ]);
    return shuffle(pairs);
  }

  function renderBoard(){
    boardEl.innerHTML = '';
    deck.forEach(card => {
      const cardEl = document.createElement('button');
      cardEl.className = 'card';
      cardEl.setAttribute('data-id', card.id);
      cardEl.setAttribute('aria-label', 'ã‚«ãƒ¼ãƒ‰');
      cardEl.innerHTML = `
        <div class="inner">
          <div class="face back" aria-hidden="${card.matched}">
            <div class="dot"><span class="mini">ã²ã‚‰ãŒãª</span></div>
          </div>
          <div class="face front">
            <div class="txt">${card.word}</div>
          </div>
        </div>`;
      boardEl.appendChild(cardEl);
    });
  }

  function resetState(newDeck=true){
    deck = newDeck ? buildDeck() : deck.map(c => ({...c, matched:false}));
    firstPick = null; secondPick = null; lockInput = false; playerTurn = true;
    youScore = 0; pcScore = 0; updateHud();
    renderBoard();
    statusEl.textContent = 'ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ï¼ã‚ãªãŸã®ç•ªã§ã™ã€‚';
  }

  function updateHud(){
    youPtsEl.textContent = youScore;
    pcPtsEl.textContent = pcScore;
    turnBadge.textContent = playerTurn ? 'ã‚ãªãŸã®ç•ª' : 'PCã®ç•ª';
    turnBadge.style.background = playerTurn ? '#eef2ff' : '#fffbeb';
    turnBadge.style.color = playerTurn ? '#3730a3' : '#92400e';
  }

  function getCardElById(id){
    return boardEl.querySelector(`.card[data-id="${id}"]`);
  }

  function flipUp(card){
    const el = getCardElById(card.id);
    if(!el) return;
    el.classList.add('flipped');
  }
  function flipDown(card){
    const el = getCardElById(card.id);
    if(!el) return;
    el.classList.remove('flipped');
  }
  function lockCard(card){
    const el = getCardElById(card.id);
    if(!el) return;
    el.classList.add('matched');
    el.setAttribute('aria-disabled', 'true');
  }

  function remainingUnmatched(){
    return deck.filter(c => !c.matched);
  }

  function checkEnd(){
    if(remainingUnmatched().length === 0){
      lockInput = true;
      const msg = (youScore === pcScore)
        ? 'å¼•ãåˆ†ã‘ï¼ãŠè¦‹äº‹ï¼'
        : (youScore > pcScore ? 'ã‚ãªãŸã®å‹ã¡ï¼ã™ã”ã„ï¼' : 'PCã®å‹ã¡â€¦æ¬¡ã¯è² ã‘ãªã„ãï¼');
      statusEl.textContent = `çµ‚äº†ï¼šã‚ãªãŸ ${youScore} - PC ${pcScore}ï½œ${msg}`;
    }
  }

  async function handlePlayerClick(e){
    const btn = e.target.closest('.card');
    if(!btn || lockInput || !playerTurn) return;
    const id = btn.getAttribute('data-id');
    const card = deck.find(c => c.id === id);
    if(!card || card.matched) return;

    // ã™ã§ã«è¡¨ãªã‚‰ç„¡è¦–
    if(btn.classList.contains('flipped')) return;

    if(!firstPick){
      firstPick = card; flipUp(card);
      return;
    }
    if(firstPick && card.id === firstPick.id){
      return; // åŒã˜ã‚«ãƒ¼ãƒ‰é€£æ‰“é˜²æ­¢
    }

    secondPick = card; flipUp(card);
    lockInput = true;

    await wait(500);

    if(firstPick.word === secondPick.word){
      // ãƒ’ãƒƒãƒˆ
      deck = deck.map(c => c.id === firstPick.id || c.id === secondPick.id ? ({...c, matched:true}) : c);
      lockCard(firstPick); lockCard(secondPick);
      youScore++; updateHud();
      statusEl.textContent = 'ãƒŠã‚¤ã‚¹ï¼ã‚‚ã†ä¸€åº¦ã©ã†ãã€‚';
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é€£ç¶šæ‰‹ç•ª
      firstPick = null; secondPick = null; lockInput = false;
      checkEnd();
    }else{
      // ãƒŸã‚¹
      statusEl.textContent = 'ã–ã‚“ã­ã‚“â€¦ PCã®ç•ªã§ã™ã€‚';
      await wait(650);
      flipDown(firstPick); flipDown(secondPick);
      firstPick = null; secondPick = null;
      playerTurn = false; updateHud();
      await wait(500);
      pcTurn();
    }
  }

  async function pcTurn(){
    lockInput = true;
    while(!playerTurn){
      // ãƒ©ãƒ³ãƒ€ãƒ ã«2æšé¸ã¶
      const candidates = remainingUnmatched();
      if(candidates.length < 2){ break; }
      const pickA = candidates[Math.floor(Math.random()*candidates.length)];
      // Bã¯Aä»¥å¤–ã‹ã‚‰
      const rest = candidates.filter(c => c.id !== pickA.id);
      const pickB = rest[Math.floor(Math.random()*rest.length)];

      statusEl.textContent = 'PCãŒã‚«ãƒ¼ãƒ‰ã‚’ã‚ãã£ã¦ã„ã¾ã™â€¦';
      flipUp(pickA); await wait(450);
      flipUp(pickB); await wait(550);

      if(pickA.word === pickB.word){
        deck = deck.map(c => (c.id===pickA.id||c.id===pickB.id) ? ({...c, matched:true}) : c);
        lockCard(pickA); lockCard(pickB);
        pcScore++; updateHud();
        statusEl.textContent = 'PCãŒå½“ã¦ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦PCã®ç•ªã€‚';
        await wait(600);
        checkEnd();
        if(remainingUnmatched().length === 0) break; // çµ‚äº†
        // ç¶šã‘ã¦PCã®ç•ª
      }else{
        statusEl.textContent = 'PCã¯ãƒã‚ºãƒ¬ã€‚ã‚ãªãŸã®ç•ªã§ã™ï¼';
        await wait(600);
        flipDown(pickA); flipDown(pickB);
        playerTurn = true; lockInput = false; updateHud();
        return; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸
      }
    }
    // ç›¤é¢ãŒå°½ããŸã¨ã
    lockInput = true; checkEnd();
  }

  function wait(ms){ return new Promise(res => setTimeout(res, ms)); }

  // ====== Words Editor ãƒ­ã‚¸ãƒƒã‚¯ ======
  function parseWordsInput(raw){
    // ã‚«ãƒ³ãƒãƒ»æ”¹è¡Œãƒ»å…¨è§’èª­ç‚¹ã§åˆ†å‰²ã€å‰å¾Œç©ºç™½é™¤å»
    const arr = raw.split(/[,ã€\n]/).map(s => s.trim()).filter(Boolean);
    // é‡è¤‡æ’é™¤
    const unique = [...new Set(arr)];
    return unique;
  }
  function updateWordCountPill(){
    wordCountPill.textContent = `${WORDS.length}èª`;
  }
  function loadWords(){
    try{
      const saved = localStorage.getItem('hiragana_pairs_words');
      if(saved){
        const arr = JSON.parse(saved);
        if(Array.isArray(arr) && arr.length === 8) return arr;
      }
    }catch(e){}
    return [...DEFAULT_WORDS];
  }
  function saveWords(words){
    localStorage.setItem('hiragana_pairs_words', JSON.stringify(words));
  }

  btnApplyWords?.addEventListener('click', () => {
    const parsed = parseWordsInput(wordsInput.value);
    if(parsed.length !== 8){
      statusEl.textContent = `ã“ã¨ã°ã¯8èªã¡ã‚‡ã†ã©ã«ã—ã¦ãã ã•ã„ï¼ˆç¾åœ¨ ${parsed.length} èªï¼‰`;
      return;
    }
    WORDS = parsed;
    saveWords(WORDS);
    updateWordCountPill();
    statusEl.textContent = 'ã“ã¨ã°ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚æ–°ã—ã„ä¸¦ã³ã§ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã™ã€‚';
    resetState(true);
  });

  btnResetWords?.addEventListener('click', () => {
    WORDS = [...DEFAULT_WORDS];
    wordsInput.value = WORDS.join(', ');
    saveWords(WORDS);
    updateWordCountPill();
    statusEl.textContent = 'ã“ã¨ã°ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚';
    resetState(true);
  });

  // ====== ã‚¤ãƒ™ãƒ³ãƒˆç´ä»˜ã‘ ======
  boardEl.addEventListener('click', handlePlayerClick);
  btnRestart.addEventListener('click', () => {
    // åŒã˜ä¸¦ã³ã§å†æŒ‘æˆ¦ï¼ˆãƒãƒƒãƒçŠ¶æ…‹ã ã‘è§£é™¤ï¼‰
    deck = deck.map(c => ({...c, matched:false}));
    renderBoard();
    firstPick = null; secondPick = null; lockInput = false; playerTurn = true;
    youScore = 0; pcScore = 0; updateHud();
    statusEl.textContent = 'ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã‚ãªãŸã®ç•ªã‹ã‚‰å†é–‹ï¼';
  });
  btnNew.addEventListener('click', () => resetState(true));

  // åˆæœŸåŒ–
  resetState(true);
})();
</script>
</body>
</html>
